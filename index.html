<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Lịch Công Tác Giáo Dục</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Times New Roman', Times, serif; background-color: #f4f6f9; color: #000; }
        .container { max-width: 1250px; background: white; padding: 40px 30px; margin-top: 20px; margin-bottom: 50px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        
        /* HEADER: GÓC TRÁI */
        .header-top { display: flex; justify-content: flex-start; text-align: center; margin-bottom: 15px; }
        
        /* CẬP NHẬT: Dòng Sở GD&ĐT bỏ in đậm (font-weight: normal) */
        .header-left h4 { margin: 0; font-size: 16px; text-transform: uppercase; font-weight: normal; }
        
        .header-left h5 { margin: 0; font-size: 16px; font-weight: bold; margin-top: 5px; text-transform: uppercase; color: #dc3545; } 
        .header-asterisk { font-weight: bold; font-size: 16px; margin-top: 2px; line-height: 1; }

        /* Tiêu đề chính */
        .main-title { text-align: center; color: #0d6efd; text-transform: uppercase; font-weight: bold; margin: 25px 0 5px 0; font-size: 24px; }
        .school-name-display { text-align: center; color: #dc3545; font-weight: bold; font-size: 18px; margin-bottom: 5px; text-transform: uppercase;}
        .date-range-display { text-align: center; font-style: italic; margin-bottom: 20px; font-size: 16px; color: #333; }
        
        .schedule-table { width: 100%; border-collapse: collapse; border: 1px solid black; table-layout: fixed; }
        
        /* Cấu hình chung cho ô bảng */
        .schedule-table th, .schedule-table td { 
            border: 1px solid black; 
            padding: 5px; 
            vertical-align: middle; 
            font-size: 15px; 
            word-wrap: break-word; 
        }

        /* --- CẤU HÌNH TIÊU ĐỀ BẢNG (THEAD) --- */
        .schedule-table thead th { 
            background-color: #e3f2fd; 
            text-align: center; 
            font-weight: bold; 
            text-transform: uppercase; 
            color: #0d47a1; 
            white-space: nowrap; 
        }
        
        /* Cấu hình cột mặc định (Desktop) */
        .col-thu { width: 90px; text-align: center; font-weight: bold; color: #0056b3; }
        .col-ngay { width: 110px; text-align: center; font-weight: bold; }
        
        /* HIGHLIGHT NGÀY HIỆN TẠI */
        .today-highlight, .today-highlight > td { 
            background-color: #fff9c4 !important; 
        }

        .general-task { color: red; font-weight: bold; text-align: center; text-transform: uppercase; padding: 10px; background-color: #fff3cd; font-size: 16px; }
        
        .task-item { margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px dashed #ccc; line-height: 1.4; display: flex; align-items: flex-start; }
        .task-item:last-child { border-bottom: none; }
        .task-bullet { color: #0288d1; margin-right: 6px; margin-top: 6px; font-size: 6px; }
        .task-content-wrapper { flex: 1; }
        .task-time { font-weight: bold; color: #000; }
        .task-person { font-style: italic; color: #555; margin-left: 4px; }
        
        /* CSS CHO MOBILE */
        td.mobile-cell-container { padding: 0 !important; }

        .mobile-session-block { 
            padding: 8px 5px; 
            background-color: transparent; 
            border-radius: 0; 
            border: none; 
        }
        
        .mobile-session-label { 
            font-size: 13px; font-weight: bold; text-transform: uppercase; 
            margin-bottom: 5px; display: block; text-decoration: underline; 
            color: #000; 
        }
        
        .mobile-separator {
            margin: 0;
            border: 0;
            border-top: 1px solid #000; 
            opacity: 1;
        }

        .control-bar { margin-top: 30px; padding: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; }
        #adminPanel { display: none; background: #fff; padding: 20px; border: 2px dashed #0288d1; border-radius: 10px; margin-top: 20px; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #0288d1; border-bottom: 3px solid #0288d1; }
        .footer-copyright { margin-top: 30px; text-align: center; font-size: 13px; color: #666; border-top: 1px solid #eee; padding-top: 15px; }
        
        @media print { 
            .no-print { display: none !important; } 
            .container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; width: 100%; } 
        }
        
        /* --- RESPONSIVE CHO ĐIỆN THOẠI --- */
        @media (max-width: 991.98px) {
            .schedule-table thead th { font-size: 12px; padding: 5px 2px; }
            .col-thu { width: 45px; font-size: 14px; padding: 2px !important; }
            .col-ngay { width: 60px; font-size: 14px; padding: 2px !important; }
            .main-title { font-size: 18px; margin-top: 15px; margin-bottom: 10px; }
            .date-range-display { font-size: 14px; margin-bottom: 10px; }
            .container { padding: 15px 10px; }
        }
        @media (max-width: 380px) {
            .schedule-table thead th { font-size: 11px; }
            .main-title { font-size: 16px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-top">
        <div class="header-left">
            <h4>SỞ GIÁO DỤC VÀ ĐÀO TẠO ĐẮK LẮK</h4>
            <h5 id="headerSchoolName">TRƯỜNG THPT SỐ 1 TRẦN PHÚ</h5>
            <div class="header-asterisk">***</div>
        </div>
    </div>

    <h2 class="main-title" id="mainTitle">LỊCH LÀM VIỆC</h2>
    <div id="subSchoolName" class="school-name-display" style="display:none"></div>
    <div id="scheduleDateRange" class="date-range-display"></div>

    <table class="schedule-table">
        <thead>
            <tr>
                <th class="col-thu">THỨ</th>
                <th class="col-ngay">NGÀY</th>
                
                <th class="d-none d-lg-table-cell">BUỔI SÁNG</th>
                <th class="d-none d-lg-table-cell">BUỔI CHIỀU</th>
                
                <th class="d-lg-none">NỘI DUNG CÔNG VIỆC</th>
            </tr>
            
            <tr class="d-none d-lg-table-row">
                <td colspan="4" class="general-task displayGeneralTask">Đang tải dữ liệu...</td>
            </tr>
            
            <tr class="d-lg-none">
                <td colspan="3" class="general-task displayGeneralTask">Đang tải dữ liệu...</td>
            </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>

    <div class="control-bar no-print">
        <div class="row align-items-center">
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text fw-bold bg-white"><i class="far fa-calendar-alt text-primary"></i>&nbsp; Xem từ ngày:</span>
                    <input type="date" id="viewDate" class="form-control" onchange="loadSchedule(true)">
                </div>
            </div>
            <div class="col-md-7 text-end">
                <button class="btn btn-secondary me-2" onclick="window.print()"><i class="fas fa-print"></i> In Lịch</button>
                <button class="btn btn-danger" onclick="toggleAdmin()"><i class="fas fa-user-lock"></i> Đăng nhập</button>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="no-print">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="text-primary m-0"><i class="fas fa-user-shield"></i> HỆ THỐNG QUẢN TRỊ <span id="adminBadge" class="badge bg-warning text-dark"></span></h5>
            <div class="d-flex align-items-center gap-2">
                <div id="userInfoDisplay" class="badge bg-info text-dark p-2"></div>
                <button id="btnChangePass" class="btn btn-sm btn-outline-warning" onclick="changePassword()">Đổi MK</button>
                <button class="btn btn-sm btn-outline-danger" onclick="logoutAdmin()">Đăng xuất</button>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="adminTabs">
            <li class="nav-item admin-only"><button class="nav-link active" onclick="switchTab('general')">1. Cấu Hình Tuần & Chung</button></li>
            <li class="nav-item"><button class="nav-link" onclick="switchTab('manual')">2. Nhập Lịch</button></li>
            <li class="nav-item admin-only"><button class="nav-link" onclick="switchTab('excel')">3. Excel (Nhập/Xuất)</button></li>
            <li class="nav-item admin-only"><button class="nav-link" onclick="switchTab('list')">4. Tất cả dữ liệu</button></li>
            <li class="nav-item admin-only"><button class="nav-link" onclick="switchTab('accounts')">5. Tài khoản con</button></li>
            <li class="nav-item root-only" style="display:none"><button class="nav-link text-danger fw-bold" onclick="switchTab('schools')">6. QUẢN LÝ TRƯỜNG</button></li>
        </ul>

        <div id="tabGeneral">
            <div class="card card-body bg-light mb-3">
                <h6 class="fw-bold text-primary"><i class="fas fa-cogs"></i> THIẾT LẬP MỐC TUẦN & NỘI DUNG CHUNG</h6>
                <div class="row g-2 align-items-end">
                    <div class="col-md-3"><label class="small fw-bold">Ngày bắt đầu áp dụng (Thứ 2):</label><input type="date" id="inputWeekStartDate" class="form-control"></div>
                    <div class="col-md-2"><label class="small fw-bold">Là Tuần thứ:</label><input type="number" id="inputWeekNum" class="form-control" placeholder="VD: 1"></div>
                    <div class="col-md-5"><label class="small fw-bold">Nội dung chung:</label><input type="text" id="inputGeneralTask" class="form-control" placeholder="VD: LỊCH HỌC KỲ II..."></div>
                    <div class="col-md-2"><button class="btn btn-primary fw-bold w-100" onclick="saveWeekConfig()">LƯU MỐC MỚI</button></div>
                </div>
            </div>
            <h6 class="fw-bold mt-3">DANH SÁCH CÁC MỐC ĐÃ LƯU</h6>
            <table class="table table-sm table-bordered"><thead class="table-secondary"><tr><th>Ngày áp dụng</th><th>Tuần thứ</th><th>Nội dung chung</th><th>Thao tác</th></tr></thead><tbody id="weekConfigsBody"></tbody></table>
        </div>

        <div id="tabManual" style="display: none;">
            <div class="row g-3">
                <input type="hidden" id="editKey">
                <div class="col-md-3"><label class="fw-bold">Ngày:</label><input type="date" id="inputDate" class="form-control"></div>
                <div class="col-md-3"><label class="fw-bold">Buổi:</label><select id="inputSession" class="form-select"><option value="Sáng">Buổi Sáng</option><option value="Chiều">Buổi Chiều</option></select></div>
                <div class="col-md-3"><label class="fw-bold">Giờ:</label><input type="text" id="inputTime" class="form-control" placeholder="07:00"></div>
                <div class="col-md-3"><label class="fw-bold">Người thực hiện:</label><input type="text" id="inputPerson" class="form-control"></div>
                <div class="col-12"><label class="fw-bold">Nội dung công việc:</label><input type="text" id="inputContent" class="form-control"></div>
                <div class="col-12 text-center mt-3">
                    <button id="btnSaveManual" class="btn btn-success px-5" onclick="addSchedule()">LƯU DỮ LIỆU</button>
                    <button id="btnCancelEdit" class="btn btn-secondary px-4" style="display:none" onclick="cancelEdit()">HỦY</button>
                </div>
            </div>
        </div>

        <div id="tabExcel" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <div class="card card-body border-success h-100">
                        <h5 class="text-success fw-bold"><i class="fas fa-file-import"></i> NHẬP LỊCH TỪ EXCEL</h5>
                        <p class="mb-2 small">File mẫu cần có cột: <b>Ngày, Buổi, Giờ, Nội dung, Người thực hiện</b></p>
                        <div class="alert alert-warning small py-2 mb-2">Nhập vào: <b><span id="excelTargetSchool">...</span></b></div>
                        <div class="input-group">
                            <input type="file" id="excelFile" class="form-control" accept=".xlsx, .xls">
                            <button class="btn btn-success" onclick="processExcelImport()"><i class="fas fa-upload"></i> Nhập</button>
                        </div>
                        <div class="mt-2 text-muted small">
                            <i>* Hỗ trợ mọi định dạng ngày: 21/01/2026, 2026-01-21, 21-1-26, v.v...</i>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-body border-primary h-100">
                        <h5 class="text-primary fw-bold"><i class="fas fa-file-download"></i> TẢI DỮ LIỆU (BACKUP)</h5>
                        <button class="btn btn-primary fw-bold w-100 mt-3" onclick="exportToExcel()"><i class="fas fa-download"></i> TẢI FILE .XLSX</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tabList" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light border rounded">
                <div class="d-flex align-items-center gap-2">
                    <label class="fw-bold mb-0">Lọc ngày:</label>
                    <input type="date" id="filterListDate" class="form-control w-auto" onchange="loadSchedule()">
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('filterListDate').value=''; loadSchedule();">Tất cả</button>
                </div>
                <button class="btn btn-danger fw-bold shadow-sm" onclick="deleteAllSchedule()"><i class="fas fa-trash-alt"></i> XÓA TOÀN BỘ</button>
            </div>
            <div class="table-responsive" style="max-height: 450px;">
                <table class="table table-sm table-bordered">
                    <thead class="table-dark"><tr><th>Ngày</th><th>Buổi</th><th>Giờ</th><th>Nội dung</th><th>Người thực hiện</th><th>Thao tác</th></tr></thead>
                    <tbody id="manageTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="tabAccounts" style="display: none;">
            <div class="card card-body mb-3 bg-light">
                <div class="row g-2">
                    <div class="col-md-5"><input type="text" id="accUsername" class="form-control" placeholder="Tên tài khoản (ví dụ: gv01)"></div>
                    <div class="col-md-4"><input type="text" id="accCode" class="form-control" maxlength="4" placeholder="Mã bảo mật (4 số)"></div>
                    <div class="col-md-3"><button class="btn btn-primary w-100" onclick="createSubAccount()">Tạo Acc Con</button></div>
                </div>
            </div>
            <table class="table table-bordered table-sm"><thead class="table-secondary"><tr><th>Tài khoản</th><th>Mã</th><th>Thao tác</th></tr></thead><tbody id="accountTableBody"></tbody></table>
        </div>

        <div id="tabSchools" style="display: none;">
            <div class="card card-body mb-3 border-danger">
                <h6 class="text-danger fw-bold" id="schoolFormTitle">TẠO TRƯỜNG THÀNH PHẦN MỚI</h6>
                <div class="row g-2">
                    <input type="hidden" id="editingSchoolKey">
                    <div class="col-md-6"><input type="text" id="newSchoolName" class="form-control" placeholder="VD: THPT Y JÚT"></div>
                    <div class="col-md-4"><input type="text" id="newSchoolCode" class="form-control" maxlength="4" value="1234"></div>
                    <div class="col-md-2 d-flex gap-1">
                        <button class="btn btn-danger w-100 fw-bold" id="btnSaveSchool" onclick="saveSchoolInfo()">LƯU</button>
                        <button class="btn btn-secondary w-100 fw-bold" id="btnCancelSchoolEdit" onclick="cancelSchoolEdit()" style="display:none">HỦY</button>
                    </div>
                </div>
                <div class="mt-2 text-muted small"><i>* Tự thêm "TRƯỜNG". User: <b>[tên không dấu]</b>.</i></div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped"><thead class="table-dark"><tr><th>Tên Trường</th><th>User</th><th>Pass</th><th>Link</th><th style="width: 140px;">Thao tác</th></tr></thead><tbody id="schoolsListBody"></tbody></table>
            </div>
        </div>
    </div>

    <div class="footer-copyright no-print">© 2026 By Dlk Edu Tech<br>Phát triển bởi: <b> tranhongdan@tranphudlk.edu.vn</b></div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Cập Nhật Công Việc</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="modalKey">
        <div class="mb-3">
            <label class="fw-bold">Ngày:</label>
            <input type="date" id="modalDate" class="form-control">
        </div>
        <div class="mb-3">
            <label class="fw-bold">Buổi:</label>
            <select id="modalSession" class="form-select">
                <option value="Sáng">Buổi Sáng</option>
                <option value="Chiều">Buổi Chiều</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="fw-bold">Giờ:</label>
            <input type="text" id="modalTime" class="form-control" placeholder="07:00">
        </div>
        <div class="mb-3">
            <label class="fw-bold">Nội dung công việc:</label>
            <input type="text" id="modalContent" class="form-control">
        </div>
        <div class="mb-3">
            <label class="fw-bold">Người thực hiện:</label>
            <input type="text" id="modalPerson" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="button" class="btn btn-primary" onclick="saveFromModal()">Lưu Thay Đổi</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, update, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyBZ7HZoLwwIO5P42Ywy_E39bxQArDQaPMo", authDomain: "lichlamviec-f7b69.firebaseapp.com", databaseURL: "https://lichlamviec-f7b69-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "lichlamviec-f7b69", storageBucket: "lichlamviec-f7b69.firebasestorage.app", messagingSenderId: "861156833276", appId: "1:861156833276:web:04574ef63f4ce74e8b6479" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUser = null; let currentRole = null; 
    let currentSchoolId = 'root'; let currentSchoolName = 'TRƯỜNG THPT SỐ 1 TRẦN PHÚ';
    let currentUserKey = null;

    function removeVietnameseTones(str) {
        str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a"); str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e"); 
        str = str.replace(/ì|í|ị|ỉ|ĩ/g,"i"); str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o"); 
        str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u"); str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y"); str = str.replace(/đ/g,"d");
        str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, "A"); str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, "E");
        str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, "I"); str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, "O");
        str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, "U"); str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, "Y"); str = str.replace(/Đ/g, "D");
        return str.toLowerCase().replace(/\s+/g, '');
    }

    // Hàm lấy ngày chuẩn (Local Time) để tránh lỗi UTC
    function formatDateISO(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function getMondayOfCurrentWeek() {
        const d = new Date(); const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(d.setDate(diff));
        return formatDateISO(monday);
    }

    function getDbPath(endpoint) { return (currentSchoolId === 'root') ? endpoint : `schools_data/${currentSchoolId}/${endpoint}`; }

    async function checkUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const schoolParam = urlParams.get('school');
        if (schoolParam) {
            const snapshot = await get(ref(db, 'schools_registry/' + schoolParam));
            if (snapshot.exists()) {
                const schoolData = snapshot.val();
                currentSchoolId = schoolParam; currentSchoolName = schoolData.name;
                document.getElementById('headerSchoolName').innerText = currentSchoolName;
                document.getElementById('excelTargetSchool').innerText = currentSchoolName;
                loadSchedule();
            } else {
                alert("Không tìm thấy trường! Quay về mặc định.");
                window.location.href = window.location.pathname;
            }
        } else { loadSchedule(); }
    }

    window.toggleAdmin = function() {
        const inputLogin = prompt("Nhập thông tin đăng nhập:\n- Admin Gốc: 123456 (hoặc mật khẩu đã đổi)\n- Admin Trường: [TênViếtLiền][MãBảoMật]\n- Tài khoản con: [Tên][Mã] (Ví dụ: gv011234)");
        if (!inputLogin) return;

        const dbRef = ref(db);
        get(dbRef).then((snapshot) => {
            let found = false;
            
            if (currentSchoolId !== 'root') {
                const schoolData = snapshot.child('schools_data/' + currentSchoolId).val();
                if (schoolData && schoolData.subAccounts) {
                    for (const [subKey, subVal] of Object.entries(schoolData.subAccounts)) {
                        const simpleUser = subVal.username.replace(currentSchoolId + "_", "");
                        if (simpleUser + subVal.code === inputLogin) {
                             const schools = snapshot.child('schools_registry').val();
                             const schoolName = schools[currentSchoolId].name;
                             setSession(currentSchoolId, 'sub_account', simpleUser, schoolName, subKey);
                             found = true; return; 
                        }
                    }
                }
                const schoolReg = snapshot.child('schools_registry/' + currentSchoolId).val();
                if (schoolReg) {
                    if (schoolReg.username + schoolReg.password === inputLogin) {
                        setSession(currentSchoolId, 'school_admin', 'ADMIN TRƯỜNG', schoolReg.name, currentSchoolId);
                        found = true; return;
                    }
                }
                if (!found) { alert("Đăng nhập thất bại!"); return; }
            } else {
                const rootPass = snapshot.child('system_config/root_password').val() || "123456";
                if (inputLogin === rootPass) {
                    setSession('root', 'root', 'ROOT ADMIN', 'TRƯỜNG THPT SỐ 1 TRẦN PHÚ', null);
                    found = true; return;
                }
                const rootSubs = snapshot.child('subAccounts').val();
                if (rootSubs) {
                    for (const [key, val] of Object.entries(rootSubs)) {
                        if (val.username + val.code === inputLogin) {
                            setSession('root', 'sub_account', val.username, 'TRƯỜNG THPT SỐ 1 TRẦN PHÚ', key);
                            found = true; return;
                        }
                    }
                }
                if (!found) { alert("Đăng nhập thất bại!"); }
            }
        });
    };

    function setSession(schoolId, role, username, schoolName, userKey) {
        currentUser = username; currentRole = role; currentSchoolId = schoolId; currentSchoolName = schoolName;
        currentUserKey = userKey; 

        document.getElementById("headerSchoolName").innerText = schoolName;
        document.getElementById("excelTargetSchool").innerText = schoolName;
        
        if (schoolId !== 'root') {
            document.getElementById("subSchoolName").innerText = schoolName;
            document.getElementById("subSchoolName").style.display = "block";
            const newUrl = `${window.location.pathname}?school=${schoolId}`;
            window.history.pushState({path: newUrl}, '', newUrl);
        } else {
            document.getElementById("subSchoolName").style.display = "none";
            const newUrl = window.location.pathname;
            window.history.pushState({path: newUrl}, '', newUrl);
        }
        showPanel(); loadSchedule(); 
    }

    function showPanel() {
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("userInfoDisplay").innerText = `User: ${currentUser} | ${currentSchoolName}`;
        const isAdmin = (currentRole === 'root' || currentRole === 'school_admin');
        const isRoot = (currentRole === 'root');
        document.getElementById("adminBadge").innerText = isRoot ? "QUẢN TRỊ VIÊN CẤP CAO" : (isAdmin ? "QUẢN TRỊ TRƯỜNG" : "THÀNH VIÊN");
        document.getElementById("btnChangePass").style.display = "block";
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
        document.querySelectorAll('.root-only').forEach(el => el.style.display = isRoot ? 'block' : 'none');
        if (!isAdmin) {
            document.getElementById('tabGeneral').style.display = 'none';
            switchTab('manual');
        } else {
            switchTab('general');
        }
        if (isRoot) loadSchoolsList();
    }

    window.changePassword = async () => {
        const newPass = prompt("Nhập mật khẩu/mã bảo mật mới:");
        if(!newPass) return;
        if (currentRole === 'root') { await set(ref(db, 'system_config/root_password'), newPass); alert("Đã đổi!"); } 
        else if(currentRole === 'school_admin') { await update(ref(db, `schools_registry/${currentUserKey}`), { password: newPass }); alert("Đã đổi!"); } 
        else if (currentRole === 'sub_account') {
            let path = (currentSchoolId === 'root') ? `subAccounts/${currentUserKey}` : `schools_data/${currentSchoolId}/subAccounts/${currentUserKey}`;
            await update(ref(db, path), { code: newPass }); alert("Đã đổi!");
        }
    };

    window.logoutAdmin = () => { window.location.href = window.location.origin + window.location.pathname; };

    window.loadSchedule = function(isUserSelected = false) {
        let viewDateStr = document.getElementById("viewDate").value;
        if (!viewDateStr && !isUserSelected) { viewDateStr = getMondayOfCurrentWeek(); document.getElementById("viewDate").value = viewDateStr; }
        const filterDate = document.getElementById("filterListDate").value;
        
        // Sử dụng hàm format Local Time để lấy ngày hiện tại chính xác
        const todayStr = formatDateISO(new Date());
        
        onValue(ref(db, getDbPath('weekConfigs')), (snap) => {
            const configs = []; snap.forEach(child => { configs.push(child.val()); });
            configs.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            if(document.getElementById("weekConfigsBody")){
                let htmlConfig = configs.map(c => `<tr><td>${c.startDate}</td><td>${c.weekNum}</td><td>${c.generalTask}</td><td><button class="btn btn-xs btn-danger" onclick="deleteWeekConfig('${c.startDate}')">Xóa</button></td></tr>`).join("");
                document.getElementById("weekConfigsBody").innerHTML = htmlConfig;
            }
            const viewDate = new Date(viewDateStr); let activeConfig = null;
            for (let i = configs.length - 1; i >= 0; i--) { if (new Date(configs[i].startDate) <= viewDate) { activeConfig = configs[i]; break; } }
            
            const taskText = activeConfig ? (activeConfig.generalTask || "LỊCH CÔNG TÁC") : "Chưa có thông tin chung";
            document.querySelectorAll(".displayGeneralTask").forEach(e => e.innerText = taskText);

            if (activeConfig) {
                const diffWeeks = Math.floor((viewDate - new Date(activeConfig.startDate)) / (1000 * 60 * 60 * 24 * 7));
                document.getElementById("mainTitle").innerText = `LỊCH LÀM VIỆC (TUẦN ${parseInt(activeConfig.weekNum) + diffWeeks})`;
            } else {
                document.getElementById("mainTitle").innerText = "LỊCH LÀM VIỆC";
            }
        });

        onValue(ref(db, getDbPath('schedules')), (snapshot) => {
            const allData = []; snapshot.forEach(child => { let v = child.val(); v.key = child.key; allData.push(v); });
            const listData = filterDate ? allData.filter(i => i.date === filterDate) : allData;
            
            const sortedList = listData.sort((a,b) => {
                const d = new Date(a.date) - new Date(b.date);
                if (d !== 0) return d;
                const t1 = (a.time || "").padStart(5, "0");
                const t2 = (b.time || "").padStart(5, "0");
                return t1.localeCompare(t2);
            });

            document.getElementById("manageTableBody").innerHTML = sortedList.map(item => `<tr><td>${item.date}</td><td>${item.session}</td><td>${item.time||''}</td><td>${item.content}</td><td>${item.person||''}</td><td><button class="btn btn-xs btn-primary" onclick="editItem('${item.key}','${item.date}','${item.session}','${item.time}','${item.content}','${item.person}')">Sửa</button> <button class="btn btn-xs btn-danger" onclick="deleteItem('${item.key}')">Xóa</button></td></tr>`).join("");
            
            let html = ""; let start = new Date(viewDateStr);
            
            const dayNames = ["Chủ Nhật", "Thứ Hai", "Thứ Ba", "Thứ Tư", "Thứ Năm", "Thứ Sáu", "Thứ Bảy"];
            const shortDayNames = ["CN", "Hai", "Ba", "Tư", "Năm", "Sáu", "Bảy"];

            for (let i = 0; i < 7; i++) {
                let d = new Date(start); d.setDate(start.getDate() + i); 
                // Sử dụng hàm format Local Time cho vòng lặp
                let dk = formatDateISO(d);
                
                let dayStr = String(d.getDate()).padStart(2,'0');
                let monthStr = String(d.getMonth()+1).padStart(2,'0');
                let dfFull = `${dayStr}/${monthStr}/${d.getFullYear()}`;
                let dfShort = `${dayStr}/${monthStr}`; 
                
                let tasks = allData.filter(t => t.date === dk);
                let morningTasks = tasks.filter(t => t.session === "Sáng");
                let afternoonTasks = tasks.filter(t => t.session === "Chiều");
                
                let renderMorning = renderTasks(morningTasks);
                let renderAfternoon = renderTasks(afternoonTasks);

                let mobileContent = "";
                if (renderMorning) {
                    mobileContent += `<div class="mobile-session-block"><span class="mobile-session-label">Buổi Sáng:</span>${renderMorning}</div>`;
                }
                // Thêm đường kẻ nếu có cả sáng và chiều
                if (renderMorning && renderAfternoon) {
                     mobileContent += `<hr class="mobile-separator">`;
                }
                if (renderAfternoon) {
                    mobileContent += `<div class="mobile-session-block"><span class="mobile-session-label">Buổi Chiều:</span>${renderAfternoon}</div>`;
                }
                
                html += `
                <tr class="${dk === todayStr ? 'today-highlight' : ''}">
                    <td class="col-thu">
                        <span class="d-none d-lg-block">${dayNames[d.getDay()]}</span>
                        <span class="d-lg-none">${shortDayNames[d.getDay()]}</span>
                    </td>
                    <td class="col-ngay">
                        <span class="d-none d-lg-block">${dfFull}</span>
                        <span class="d-lg-none">${dfShort}</span>
                    </td>
                    
                    <td class="d-none d-lg-table-cell">${renderMorning}</td>
                    <td class="d-none d-lg-table-cell">${renderAfternoon}</td>
                    
                    <td class="d-lg-none mobile-cell-container">${mobileContent}</td>
                </tr>`;
            }
            document.getElementById("scheduleBody").innerHTML = html;
            let end = new Date(start); end.setDate(start.getDate()+6);
            document.getElementById("scheduleDateRange").innerText = `(Từ ngày ${start.getDate()}/${start.getMonth()+1} đến ngày ${end.getDate()}/${end.getMonth()+1}/${end.getFullYear()})`;
        });
    };

    function renderTasks(tasks) { 
        return tasks.sort((a,b) => {
            const t1 = (a.time || '23:59').padStart(5, '0');
            const t2 = (b.time || '23:59').padStart(5, '0');
            return t1.localeCompare(t2);
        }).map(t => `<div class="task-item"><i class="fas fa-circle task-bullet"></i><div class="task-content-wrapper"><b>${t.time?t.time+':':''}</b> ${t.content} <i>${t.person?'('+t.person+')':''}</i></div></div>`).join(""); 
    }

    window.switchTab = (n) => {
        ['general','manual','excel','list','accounts','schools'].forEach(id => { const el = document.getElementById('tab'+id.charAt(0).toUpperCase()+id.slice(1)); if(el) el.style.display = (id === n) ? 'block' : 'none'; });
        document.querySelectorAll('#adminTabs .nav-link').forEach(l => l.classList.toggle('active', l.innerText.toLowerCase().includes(n === 'schools' ? 'quản lý trường' : (n === 'excel' ? 'excel' : (n === 'list' ? 'dữ liệu' : (n === 'accounts' ? 'tài khoản' : (n === 'general' ? 'chung' : 'nhập lịch')))))));
    };
    
    window.saveWeekConfig = () => {
        const startDate = document.getElementById("inputWeekStartDate").value; const weekNum = document.getElementById("inputWeekNum").value; const generalTask = document.getElementById("inputGeneralTask").value;
        if (!startDate || !weekNum) { alert("Thiếu thông tin!"); return; }
        update(ref(db, getDbPath(`weekConfigs/${startDate.replace(/-/g, "")}`)), { startDate, weekNum: parseInt(weekNum), generalTask }).then(() => { alert("Đã lưu!"); document.getElementById("inputWeekStartDate").value=""; });
    };
    window.deleteWeekConfig = (startDate) => { if(confirm("Xóa mốc này?")) remove(ref(db, getDbPath(`weekConfigs/${startDate.replace(/-/g, "")}`))); };

    window.deleteAllSchedule = async () => {
        if (currentRole === 'sub_account') { alert("Không đủ quyền!"); return; }
        const confirmInput = prompt("CẢNH BÁO: Nhập chính xác [TênTàiKhoản][MậtKhẩu] (viết liền) để xóa.\nVD: truongthptyjut1234");
        if (!confirmInput) return;
        let isAuth = false;
        if (currentRole === 'root') { 
            const snap = await get(ref(db, 'system_config/root_password'));
            const rootPass = snap.val() || "123456";
            if (confirmInput.trim() === rootPass) isAuth = true; 
        } 
        else if (currentRole === 'school_admin') { 
            const s = await get(ref(db, 'schools_registry/' + currentSchoolId)); 
            if (s.exists()) {
                const fullAuth = String(s.val().username).trim() + String(s.val().password).trim();
                if (confirmInput.trim() === fullAuth) isAuth = true; 
            }
        }
        if (isAuth) { remove(ref(db, getDbPath('schedules'))).then(() => alert("Đã xóa sạch!")).catch(e => alert("Lỗi: "+e)); } 
        else { alert("Thông tin xác nhận KHÔNG ĐÚNG!"); }
    };

    window.processExcelImport = () => { 
        const f=document.getElementById('excelFile').files[0]; if(!f){alert("Chọn file!");return;} 
        const r=new FileReader(); 
        r.onload=e=>{ 
            const d=new Uint8Array(e.target.result); const wb=XLSX.read(d,{type:'array'}); 
            const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); 
            let c=0; 
            json.forEach(row=>{ 
                const rd=row['Ngày']||row['ngay']||row['date']; 
                const s=row['Buổi']||row['buoi']||'Sáng'; 
                const t=row['Giờ']||row['gio']||''; 
                const ct=row['Nội dung']||row['noi dung']||row['content']; 
                const p=row['Người thực hiện']||row['nguoi thuc hien']||''; 
                if(rd&&ct){ 
                    const validDate = parseFlexibleDate(rd);
                    if(validDate) {
                        push(ref(db, getDbPath('schedules')), {date:validDate, session:s, time:t, content:ct, person:p, creator:currentUser+"(Excel)"}); 
                        c++; 
                    }
                } 
            }); 
            alert("Đã nhập "+c+" dòng!"); loadSchedule(); 
        }; 
        r.readAsArrayBuffer(f); 
    };

    function parseFlexibleDate(input) {
        if (!input) return '';
        if (typeof input === 'number') {
            const d = new Date((Math.floor(input - 25569) * 86400) * 1000);
            return isNaN(d.getTime()) ? '' : d.toISOString().split('T')[0];
        }
        let str = String(input).trim();
        if (str.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) return str;
        str = str.replace(/-/g, '/').replace(/\./g, '/');
        const p = str.split('/');
        if (p.length === 3) {
            let d = p[0], m = p[1], y = p[2];
            if (d.length === 4) { [y, m, d] = [p[0], p[1], p[2]]; }
            d = d.padStart(2,'0'); m = m.padStart(2,'0');
            if (y.length === 2) y = "20" + y;
            return `${y}-${m}-${d}`;
        }
        return '';
    }

    window.exportToExcel = () => { if(!confirm("Tải xuống?"))return; get(ref(db, getDbPath('schedules'))).then(s=>{if(!s.exists()){alert("Trống!");return;} const d=[]; s.forEach(c=>{const v=c.val(); d.push({"Ngày":v.date,"Buổi":v.session,"Giờ":v.time,"Nội dung":v.content,"Người":v.person});}); d.sort((a,b)=>new Date(a['Ngày'])-new Date(b['Ngày'])); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(d),"Lich"); XLSX.writeFile(wb,`Lich_${removeVietnameseTones(currentSchoolName)}.xlsx`); }); };
    
    window.createSubAccount = () => { 
        const u = document.getElementById("accUsername").value.trim(); 
        const c = document.getElementById("accCode").value.trim(); 
        if(u && c.length === 4){ 
            const realUsername = (currentSchoolId !== 'root') ? (currentSchoolId + "_" + u) : u;
            push(ref(db, getDbPath('subAccounts')), {username: realUsername, code:c}); 
            alert("Đã tạo!"); 
            document.getElementById("accUsername").value=''; 
            document.getElementById("accCode").value=''; 
        } 
    };

    function loadSubAccounts() { 
        onValue(ref(db, getDbPath('subAccounts')), s=>{ 
            let h=""; 
            s.forEach(c=>{ 
                const displayUser = c.val().username.replace(currentSchoolId + "_", "");
                h+=`<tr><td>${displayUser}</td><td>${c.val().code}</td><td><button class="btn btn-xs btn-danger" onclick="removeAcc('${c.key}')">Xóa</button></td></tr>`; 
            }); 
            document.getElementById("accountTableBody").innerHTML=h; 
        }); 
    }

    window.removeAcc = (k) => confirm("Xóa?") && remove(ref(db, getDbPath(`subAccounts/${k}`)));
    
    window.addSchedule = () => { const d={date:document.getElementById("inputDate").value, session:document.getElementById("inputSession").value, time:document.getElementById("inputTime").value, content:document.getElementById("inputContent").value, person:document.getElementById("inputPerson").value, creator:currentUser}; const k=document.getElementById("editKey").value; if(k) update(ref(db, getDbPath('schedules/'+k)), d).then(cancelEdit); else push(ref(db, getDbPath('schedules')), d).then(cancelEdit); };
    window.cancelEdit = () => { document.getElementById("editKey").value=""; document.getElementById("inputContent").value=""; loadSchedule(); };
    
    window.editItem = (k,d,s,t,c,p) => { 
        document.getElementById("modalKey").value = k;
        document.getElementById("modalDate").value = d;
        document.getElementById("modalSession").value = s;
        document.getElementById("modalTime").value = t;
        document.getElementById("modalContent").value = c;
        document.getElementById("modalPerson").value = p;
        const myModal = new bootstrap.Modal(document.getElementById('editModal'));
        myModal.show();
    };

    window.saveFromModal = () => {
        const k = document.getElementById("modalKey").value;
        const d = {
            date: document.getElementById("modalDate").value,
            session: document.getElementById("modalSession").value,
            time: document.getElementById("modalTime").value,
            content: document.getElementById("modalContent").value,
            person: document.getElementById("modalPerson").value,
            creator: currentUser + " (Edited)"
        };
        update(ref(db, getDbPath('schedules/'+k)), d).then(() => {
            const modalEl = document.getElementById('editModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        });
    };

    window.deleteItem = (k) => confirm("Xóa?") && remove(ref(db, getDbPath('schedules/'+k)));

    window.saveSchoolInfo = () => { if(currentRole!=='root')return; const k=document.getElementById("editingSchoolKey").value; let n=document.getElementById("newSchoolName").value.trim(); const c=document.getElementById("newSchoolCode").value.trim(); if(!n||c.length<4){alert("Lỗi nhập!");return;} if(!n.toUpperCase().startsWith("TRƯỜNG")) n="TRƯỜNG "+n; n=n.toUpperCase(); if(k){ update(ref(db,'schools_registry/'+k),{name:n,password:c}).then(()=>{alert("Cập nhật xong!");cancelSchoolEdit();}); } else { const u=removeVietnameseTones(n); get(ref(db,'schools_registry/'+u)).then(s=>{ if(s.exists())alert("Trùng!"); else set(ref(db,'schools_registry/'+u),{name:n,username:u,password:c,createdAt:new Date().toISOString()}).then(()=>{alert("Đã tạo!");cancelSchoolEdit();}); }); } };
    window.startEditSchool = (u,n,p) => { document.getElementById("editingSchoolKey").value=u; document.getElementById("newSchoolName").value=n; document.getElementById("newSchoolCode").value=p; document.getElementById("schoolFormTitle").innerText="CẬP NHẬT TRƯỜNG"; document.getElementById("btnSaveSchool").innerText="CẬP NHẬT"; document.getElementById("btnCancelSchoolEdit").style.display="block"; };
    window.cancelSchoolEdit = () => { document.getElementById("editingSchoolKey").value=""; document.getElementById("newSchoolName").value=""; document.getElementById("newSchoolCode").value="1234"; document.getElementById("schoolFormTitle").innerText="TẠO TRƯỜNG MỚI"; document.getElementById("btnSaveSchool").innerText="TẠO NGAY"; document.getElementById("btnCancelSchoolEdit").style.display="none"; };
    window.deleteSchool = (u) => { if(!confirm("Xóa vĩnh viễn trường này?"))return; const p=prompt("Mật khẩu ROOT:"); if(p!=='123456'){alert("Sai mật khẩu!");return;} remove(ref(db,'schools_registry/'+u)); remove(ref(db,'schools_data/'+u)); alert("Đã xóa!"); };
    window.copyLink = (u) => { const l=window.location.origin+window.location.pathname+"?school="+u; navigator.clipboard.writeText(l).then(()=>alert("Đã copy: "+l)); };
    function loadSchoolsList() { onValue(ref(db,'schools_registry'),s=>{ let h=""; s.forEach(c=>{ const v=c.val(); h+=`<tr><td>${v.name}</td><td>${v.username}</td><td>${v.password}</td><td><button class="btn btn-sm btn-info" onclick="copyLink('${v.username}')">Link</button></td><td><button class="btn btn-sm btn-warning" onclick="startEditSchool('${v.username}','${v.name}','${v.password}')">Sửa</button> <button class="btn btn-sm btn-danger" onclick="deleteSchool('${v.username}')">Xóa</button></td></tr>`; }); document.getElementById("schoolsListBody").innerHTML=h; }); }

    checkUrlParams();
    const originalSwitchTab = window.switchTab;
    window.switchTab = function(n) { originalSwitchTab(n); if(n==='accounts') loadSubAccounts(); }
</script>
</body>
</html>
